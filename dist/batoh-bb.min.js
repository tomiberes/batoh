!function(){"use strict";{var n=window.Batoh={},e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange}window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor;var t=n.Pocket=function(n){this.setup={database:"Batoh",version:1,stores:{store:{keyPath:null,autoIncrement:!0,indexes:[]}}};for(var e in this.setup)this.setup[e]="undefined"!=typeof n[e]?n[e]:this.setup[e];this.db=null};t.prototype={openDB:function(n){var t=this,r=e.open(t.setup.database,t.setup.version);r.onsuccess=function(e){t.db=e.target.result,n&&"function"==typeof n&&n(null)},r.onerror=function(e){n&&"function"==typeof n&&n(e.target.error)},r.onblocked=function(e){n&&"function"==typeof n&&n(e.target.error)},r.onupgradeneeded=function(n){t.db=n.target.result;for(var e in t.setup.stores){var r=t.setup.stores[e],o=t.db.createObjectStore(e,{keyPath:r.keyPath,autoIncrement:r.autoIncrement});for(var i in r.indexes)o.createIndex(r.indexes[i].name,r.indexes[i].keyPath)}}},closeDB:function(){this.db&&this.db.close()},deleteDB:function(n){if(e.deleteDatabase){var t=e.deleteDatabase(this.setup.database);t.onsuccess=function(e){return n&&"function"==typeof n?n(null,e.target.result):void 0},t.onerror=function(){},t.onblocked=function(){},t.onversionchange=function(){}}},add:function(n,e,t,r){var o={};4===arguments.length&&(o.key=Array.isArray(t)?t:[t]),3===arguments.length&&(r=t,t=null),o.value=Array.isArray(e)?e:[e];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.oncomplete=function(){return r&&"function"==typeof r?(i=1===i.length?i[0]:i,r(null,i)):void 0};for(var c=u.objectStore(n),a=function(n,e){var t=c.add(n,e);t.onsuccess=function(n){i.push(n.target.result)},t.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},s=0;s<o.value.length;s++)o.key?a(o.value[s],o.key[s]):a(o.value[s])},get:function(n,e,t){var r=this.db.transaction(n,"readonly");r.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},r.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},r.oncomplete=function(){return t&&"function"==typeof t?t(null,u):void 0};var o=r.objectStore(n),i=o.get(e),u=null;i.onsuccess=function(n){u=n.target.result},i.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}},query:function(n,e,t,r){3===arguments.length&&(r=t,t=null),2===arguments.length&&(r=e,e=null,t=null);var o=[],i=this.db.transaction(n,"readonly");i.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},i.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},i.oncomplete=function(){return r&&"function"==typeof r?r(null,o):void 0};var u=i.objectStore(n),c=u;if(null!==e&&e.index&&(c=u.index(e.index)),null!==e&&e.limit)var a=e.limit;var s;s=null===e?c.openCursor():c.openCursor(e.range,e.direction),s.onsuccess=function(n){var e=n.target.result;if(e){if(t?t(e.value):o.push(e.value),a&&(a--,0===a))return;e.continue()}},s.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},put:function(n,e,t,r){var o={};4===arguments.length&&(o.key=Array.isArray(t)?t:[t]),3===arguments.length&&(r=t,t=null),o.value=Array.isArray(e)?e:[e];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.oncomplete=function(){return i=1===i.length?i[0]:i,r&&"function"==typeof r?r(null,i):void 0};for(var c=u.objectStore(n),a=function(n,e){var t=c.put(n,e);t.onsuccess=function(n){i.push(n.target.result)},t.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},s=0;s<o.value.length;s++)o.key?a(o.value[s],o.key[s]):a(o.value[s])},"delete":function(n,e,t){var r=this.db.transaction(n,"readwrite");r.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},r.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},r.oncomplete=function(){return t&&"function"==typeof t?t(null):void 0};var o=r.objectStore(n),i=o.delete(e);i.onsuccess=function(){},i.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}},clear:function(n,e){var t=this.db.transaction(n,"readwrite");t.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},t.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},t.oncomplete=function(){return e&&"function"==typeof e?e(null):void 0};var r=t.objectStore(n),o=r.clear();o.onsuccess=function(){},o.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}}}}(),function(){"use strict";var n=window.Batoh,e=window.$,t=window.Backbone;n.backboneSync=function(t,r,o){var i,u,c,a=e.Deferred(),s=r.toJSON();if(s instanceof Array)u=r.setup,c=r.store,i=new n.Pocket(u),i.openDB(function(n){n&&a.reject(),i.query(c,function(n,e){return n?(o.error(n),a.reject(),void i.closeDB()):(o.success(e),a.resolve(),void i.closeDB())})});else{if(u=r.collection.setup,c=r.collection.store,i=new n.Pocket(u),!s.id){var f=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};s.id=f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()}var d={create:function(n){i.add(c,s,n)},update:function(n){i.put(c,s,n)},patch:function(){console.log("PATCH not implemented")},"delete":function(n){i.delete(c,s[u.stores[c].keyPath],n)},read:function(n){i.get(c,s[u.stores[c].keyPath],n)}};i.openDB(function(n){n&&a.reject(),d[t](function(n,e){return n?(o.error(n),a.reject(),void i.closeDB()):"read"===t?(o.success(e),a.resolve(),void i.closeDB()):void d.read(function(n,e){o.success(e),a.resolve(),i.closeDB()})})})}return a.promise()},t.sync=n.backboneSync}();