!function(){"use strict";{var n=window.Batoh={},t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange}window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor;var e=n.Pocket=function(n){this.setup={database:"Batoh",version:1,stores:{store:{keyPath:null,autoIncrement:!0,indexes:[]}}};for(var t in this.setup)this.setup[t]="undefined"!=typeof n[t]?n[t]:this.setup[t];this.db=null};e.prototype={openDB:function(n){var e=this,o=t.open(e.setup.database,e.setup.version);o.onsuccess=function(t){e.db=t.target.result,n&&"function"==typeof n&&n(null)},o.onerror=function(t){n&&"function"==typeof n&&n(t.target.error)},o.onblocked=function(t){n&&"function"==typeof n&&n(t.target.error)},o.onupgradeneeded=function(n){e.db=n.target.result;for(var t in e.setup.stores){var o=e.setup.stores[t],r=e.db.createObjectStore(t,{keyPath:o.keyPath,autoIncrement:o.autoIncrement});for(var i in o.indexes)r.createIndex(o.indexes[i].name,o.indexes[i].keyPath)}}},closeDB:function(){this.db&&this.db.close()},deleteDB:function(n){if(t.deleteDatabase){var e=t.deleteDatabase(this.setup.database);e.onsuccess=function(t){return n&&"function"==typeof n?n(null,t.target.result):void 0},e.onerror=function(){},e.onblocked=function(){},e.onversionchange=function(){}}},add:function(n,t,e,o){var r={};4===arguments.length&&(r.key=Array.isArray(e)?e:[e]),3===arguments.length&&(o=e,e=null),r.value=Array.isArray(t)?t:[t];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.oncomplete=function(){return o&&"function"==typeof o?(i=1===i.length?i[0]:i,o(null,i)):void 0};for(var a=u.objectStore(n),c=function(n,t){var e=a.add(n,t);e.onsuccess=function(n){i.push(n.target.result)},e.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},s=0;s<r.value.length;s++)r.key?c(r.value[s],r.key[s]):c(r.value[s])},get:function(n,t,e){var o=this.db.transaction(n,"readonly");o.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},o.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},o.oncomplete=function(){return e&&"function"==typeof e?e(null,u):void 0};var r=o.objectStore(n),i=r.get(t),u=null;i.onsuccess=function(n){u=n.target.result},i.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}},query:function(n,t,e,o){3===arguments.length&&(o=e,e=null),2===arguments.length&&(o=t,t=null,e=null);var r=[],i=this.db.transaction(n,"readonly");i.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},i.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},i.oncomplete=function(){return o&&"function"==typeof o?o(null,r):void 0};var u=i.objectStore(n),a=u;if(null!==t&&t.index&&(a=u.index(t.index)),null!==t&&t.limit)var c=t.limit;var s;s=null===t?a.openCursor():a.openCursor(t.range,t.direction),s.onsuccess=function(n){var t=n.target.result;if(t){if(e?e(t.value):r.push(t.value),c&&(c--,0===c))return;t.continue()}},s.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},put:function(n,t,e,o){var r={};4===arguments.length&&(r.key=Array.isArray(e)?e:[e]),3===arguments.length&&(o=e,e=null),r.value=Array.isArray(t)?t:[t];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.oncomplete=function(){return i=1===i.length?i[0]:i,o&&"function"==typeof o?o(null,i):void 0};for(var a=u.objectStore(n),c=function(n,t){var e=a.put(n,t);e.onsuccess=function(n){i.push(n.target.result)},e.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},s=0;s<r.value.length;s++)r.key?c(r.value[s],r.key[s]):c(r.value[s])},"delete":function(n,t,e){var o=this.db.transaction(n,"readwrite");o.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},o.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},o.oncomplete=function(){return e&&"function"==typeof e?e(null):void 0};var r=o.objectStore(n),i=r.delete(t);i.onsuccess=function(){},i.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}},clear:function(n,t){var e=this.db.transaction(n,"readwrite");e.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},e.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},e.oncomplete=function(){return t&&"function"==typeof t?t(null):void 0};var o=e.objectStore(n),r=o.clear();r.onsuccess=function(){},r.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}}}}(),function(){"use strict";var n=window.Batoh;n.sync=function(t,e,o){function r(n){var t={index:"timestamp",range:IDBKeyRange.upperBound(Number.POSITIVE_INFINITY,!0),direction:"prev",limit:1};y.openDB(function(){y.query(e,t,function(t,e){t&&n(t);var o=e[0]?e[0].timestamp:0;y.closeDB(),i(o)})})}function i(n){var t,e=new XMLHttpRequest;e.open("GET",m+"?last_sync="+n,!0),e.send(),e.onload=function(){t=this.response;var n=JSON.parse(t);u(n)},e.onerror=function(n){v(n)}}function u(n){var t=g(n.length,y,c);y.openDB(function(){for(var o=0;o<n.length;o++)y.get(e,n[o].uuid,function(r,i){var u=i;r&&v(r),null!==u?u.dirty===!0?a(u,n[o],t):n[o].deleted===!0?y.delete(e,u.id,function(n){n&&v(n),t()}):y.put(e,n[o],function(n){n&&v(n),t()}):y.add(e,n[o],function(n){n&&v(n),t()})})})}function a(n,t,e){e()}function c(){var n={index:"timestamp",range:null,direction:"next"},t=function(n){n.dirty===!0&&(""===n.timestamp?h.push(n):w.push(n))};y.openDB(function(){y.query(e,n,t,function(n){n&&v(n),y.closeDB(),s()})})}function s(){var n=g(h.length+w.length,null,p);if(h.length>0)for(var t=0;t<h.length;t++)f(h[t],n);if(w.length>0)for(var e=0;e<w.length;e++)d(w[e],n)}function f(n,t){var e,o=JSON.stringify(n),r=new XMLHttpRequest;r.open("POST",m,!0),r.setRequestHeader("Content-type","application/json; charset=utf-8"),r.send(o),r.onload=function(){return e=JSON.parse(this.response),e.timestamp?(n.timestamp=e.timestamp,void l(n,t)):v(new Error("No timestamp in POST response."))},r.onerror=function(n){v(n),t()}}function d(n,t){var e,o=JSON.stringify(n),r=new XMLHttpRequest;r.open("PUT",m+"/"+n.id,!0),r.setRequestHeader("Content-type","application/json; charset=utf-8"),r.send(o),r.onload=function(){return e=JSON.parse(this.response),e.timestamp?(n.timestamp=e.timestamp,void l(n,t)):v(new Error("No timestamp in PUT response."))},r.onerror=function(n){v(n),t()}}function l(n,t){y.openDB(function(){n.deleted?y.delete(e,n.id,function(){y.closeDB(),t()}):(n.dirty=!1,y.put(e,n,n.id,function(){y.closeDB(),t()}))})}function p(){console.log("sync complete")}function v(n){console.error(n.message)}function g(n,t,e){if(0===n)return e();var o=n,r=function(){return o--,0===o?(t&&t.closeDB(),e()):void 0};return r}var y=new n.Pocket(t),m="/"+e||o.url;o.onComplete&&(p=o.onComplete),o.onError&&(v=o.onError),o.resolveConflict&&(a=o.resolveConflict);var h=[],w=[];r()}}();