!function(){"use strict";{var n=window.Batoh={},e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange}window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor;var t=n.Pocket=function(n){this.setup={database:"Batoh",version:1,stores:{store:{keyPath:null,autoIncrement:!0,indexes:[]}}};for(var e in this.setup)this.setup[e]="undefined"!=typeof n[e]?n[e]:this.setup[e];this.db=null};t.prototype={openDB:function(n){var t=this,o=e.open(t.setup.database,t.setup.version);o.onsuccess=function(e){t.db=e.target.result,n&&"function"==typeof n&&n(null)},o.onerror=function(e){n&&"function"==typeof n&&n(e.target.error)},o.onblocked=function(e){n&&"function"==typeof n&&n(e.target.error)},o.onupgradeneeded=function(n){t.db=n.target.result;for(var e in t.setup.stores){var o=t.setup.stores[e],r=t.db.createObjectStore(e,{keyPath:o.keyPath,autoIncrement:o.autoIncrement});for(var i in o.indexes)r.createIndex(o.indexes[i].name,o.indexes[i].keyPath)}}},closeDB:function(){this.db&&this.db.close()},deleteDB:function(n){if(e.deleteDatabase){var t=e.deleteDatabase(this.setup.database);t.onsuccess=function(e){return n&&"function"==typeof n?n(null,e.target.result):void 0},t.onerror=function(){},t.onblocked=function(){},t.onversionchange=function(){}}},add:function(n,e,t,o){var r={};4===arguments.length&&(r.key=Array.isArray(t)?t:[t]),3===arguments.length&&(o=t,t=null),r.value=Array.isArray(e)?e:[e];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.oncomplete=function(){return o&&"function"==typeof o?(i=1===i.length?i[0]:i,o(null,i)):void 0};for(var c=u.objectStore(n),a=function(n,e){var t=c.add(n,e);t.onsuccess=function(n){i.push(n.target.result)},t.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},s=0;s<r.value.length;s++)r.key?a(r.value[s],r.key[s]):a(r.value[s])},get:function(n,e,t){var o=this.db.transaction(n,"readonly");o.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},o.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},o.oncomplete=function(){return t&&"function"==typeof t?t(null,u):void 0};var r=o.objectStore(n),i=r.get(e),u=null;i.onsuccess=function(n){u=n.target.result},i.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}},query:function(n,e,t,o){3===arguments.length&&(o=t,t=null),2===arguments.length&&(o=e,e=null,t=null);var r=[],i=this.db.transaction(n,"readonly");i.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},i.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},i.oncomplete=function(){return o&&"function"==typeof o?o(null,r):void 0};var u=i.objectStore(n),c=u;if(null!==e&&e.index&&(c=u.index(e.index)),null!==e&&e.limit)var a=e.limit;var s;s=null===e?c.openCursor():c.openCursor(e.range,e.direction),s.onsuccess=function(n){var e=n.target.result;if(e){if(t?t(e.value):r.push(e.value),a&&(a--,0===a))return;e.continue()}},s.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},put:function(n,e,t,o){var r={};4===arguments.length&&(r.key=Array.isArray(t)?t:[t]),3===arguments.length&&(o=t,t=null),r.value=Array.isArray(e)?e:[e];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0},u.oncomplete=function(){return i=1===i.length?i[0]:i,o&&"function"==typeof o?o(null,i):void 0};for(var c=u.objectStore(n),a=function(n,e){var t=c.put(n,e);t.onsuccess=function(n){i.push(n.target.result)},t.onerror=function(n){return o&&"function"==typeof o?o(n.target.error):void 0}},s=0;s<r.value.length;s++)r.key?a(r.value[s],r.key[s]):a(r.value[s])},"delete":function(n,e,t){var o=this.db.transaction(n,"readwrite");o.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},o.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},o.oncomplete=function(){return t&&"function"==typeof t?t(null):void 0};var r=o.objectStore(n),i=r.delete(e);i.onsuccess=function(){},i.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}},clear:function(n,e){var t=this.db.transaction(n,"readwrite");t.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},t.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},t.oncomplete=function(){return e&&"function"==typeof e?e(null):void 0};var o=t.objectStore(n),r=o.clear();r.onsuccess=function(){},r.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}}}}(),function(){"use strict";var n=window.Batoh;n.sync=function(e,t,o){function r(n){var e={index:"timestamp",range:IDBKeyRange.upperBound(Number.POSITIVE_INFINITY,!0),direction:"prev",limit:1};g.openDB(function(){g.query(t,e,function(e,t){e&&n(e);var o=t[0]?t[0].timestamp:0;g.closeDB(),i(o)})})}function i(n){var e,t=new XMLHttpRequest;t.open("GET",h+"?last_sync="+n,!0),t.send(),t.onload=function(){e=this.response;var n=JSON.parse(e);u(n)},t.onerror=function(n){v(n)}}function u(n){var e=y(n.length,g,a);g.openDB(function(){for(var o=0;o<n.length;o++)g.get(t,n[o].uuid,function(r,i){var u=i;r&&v(r),null!==u?u.dirty===!0?c(u,n[o],e):n[o].deleted===!0?g.delete(t,u.id,function(n){n&&v(n),e()}):g.put(t,n[o],function(n){n&&v(n),e()}):g.add(t,n[o],function(n){n&&v(n),e()})})})}function c(n,e,t){t()}function a(){var n={index:"timestamp",range:null,direction:"next"},e=function(n){n.dirty===!0&&(""===n.timestamp?m.push(n):w.push(n))};g.openDB(function(){g.query(t,n,e,function(n){n&&v(n),g.closeDB(),s()})})}function s(){var n=y(m.length+w.length,null,p);if(m.length>0)for(var e=0;e<m.length;e++)f(m[e],n);if(w.length>0)for(var t=0;t<w.length;t++)d(w[t],n)}function f(n,e){var t,o=JSON.stringify(n),r=new XMLHttpRequest;r.open("POST",h,!0),r.setRequestHeader("Content-type","application/json; charset=utf-8"),r.send(o),r.onload=function(){return t=JSON.parse(this.response),t.timestamp?(n.timestamp=t.timestamp,void l(n,e)):v(new Error("No timestamp in POST response."))},r.onerror=function(n){v(n),e()}}function d(n,e){var t,o=JSON.stringify(n),r=new XMLHttpRequest;r.open("PUT",h+"/"+n.id,!0),r.setRequestHeader("Content-type","application/json; charset=utf-8"),r.send(o),r.onload=function(){return t=JSON.parse(this.response),t.timestamp?(n.timestamp=t.timestamp,void l(n,e)):v(new Error("No timestamp in PUT response."))},r.onerror=function(n){v(n),e()}}function l(n,e){g.openDB(function(){n.deleted?g.delete(t,n.id,function(){g.closeDB(),e()}):(n.dirty=!1,g.put(t,n,n.id,function(){g.closeDB(),e()}))})}function p(){console.log("sync complete")}function v(n){console.error(n.message)}function y(n,e,t){if(0===n)return t();var o=n,r=function(){return o--,0===o?(e&&e.closeDB(),t()):void 0};return r}var g=new n.Pocket(e),h="/"+t||o.url;o.onComplete&&(p=o.onComplete),o.onError&&(v=o.onError),o.resolveConflict&&(c=o.resolveConflict);var m=[],w=[];r()}}(),function(){"use strict";var n=window.Batoh,e=window.$,t=window.Backbone;n.backboneSync=function(t,o,r){var i,u,c,a=e.Deferred(),s=o.toJSON();if(s instanceof Array)u=o.setup,c=o.store,i=new n.Pocket(u),i.openDB(function(n){n&&a.reject(),i.query(c,function(n,e){return n?(r.error(n),a.reject(),void i.closeDB()):(r.success(e),a.resolve(),void i.closeDB())})});else{if(u=o.collection.setup,c=o.collection.store,i=new n.Pocket(u),!s.id){var f=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};s.id=f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()}var d={create:function(n){i.add(c,s,n)},update:function(n){i.put(c,s,n)},patch:function(){console.log("PATCH not implemented")},"delete":function(n){i.delete(c,s[u.stores[c].keyPath],n)},read:function(n){i.get(c,s[u.stores[c].keyPath],n)}};i.openDB(function(n){n&&a.reject(),d[t](function(n,e){return n?(r.error(n),a.reject(),void i.closeDB()):"read"===t?(r.success(e),a.resolve(),void i.closeDB()):void d.read(function(n,e){r.success(e),a.resolve(),i.closeDB()})})})}return a.promise()},t.sync=n.backboneSync}();