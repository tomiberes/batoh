!function(){"use strict";{var n=window.Batoh={},t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange||window.webkitIDBKeyRange}window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.mozIDBCursor||window.msIDBCursor;var e=n.Pocket=function(n){this.setup={database:"Batoh",version:1,stores:{store:{keyPath:null,autoIncrement:!0,indexes:[]}}};for(var t in this.setup)this.setup[t]="undefined"!=typeof n[t]?n[t]:this.setup[t];this.db=null};e.prototype={openDB:function(n){var e=this,r=t.open(e.setup.database,e.setup.version);r.onsuccess=function(t){e.db=t.target.result,n&&"function"==typeof n&&n(null)},r.onerror=function(t){n&&"function"==typeof n&&n(t.target.error)},r.onblocked=function(t){n&&"function"==typeof n&&n(t.target.error)},r.onupgradeneeded=function(n){e.db=n.target.result;for(var t in e.setup.stores){var r=e.setup.stores[t],o=e.db.createObjectStore(t,{keyPath:r.keyPath,autoIncrement:r.autoIncrement});for(var i in r.indexes)o.createIndex(r.indexes[i].name,r.indexes[i].keyPath)}}},closeDB:function(){this.db&&this.db.close()},deleteDB:function(n){if(t.deleteDatabase){var e=t.deleteDatabase(this.setup.database);e.onsuccess=function(t){return n&&"function"==typeof n?n(null,t.target.result):void 0},e.onerror=function(){},e.onblocked=function(){},e.onversionchange=function(){}}},add:function(n,t,e,r){var o={};4===arguments.length&&(o.key=Array.isArray(e)?e:[e]),3===arguments.length&&(r=e,e=null),o.value=Array.isArray(t)?t:[t];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.oncomplete=function(){return r&&"function"==typeof r?(i=1===i.length?i[0]:i,r(null,i)):void 0};for(var a=u.objectStore(n),c=function(n,t){var e=a.add(n,t);e.onsuccess=function(n){i.push(n.target.result)},e.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},s=0;s<o.value.length;s++)o.key?c(o.value[s],o.key[s]):c(o.value[s])},get:function(n,t,e){var r=this.db.transaction(n,"readonly");r.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},r.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},r.oncomplete=function(){return e&&"function"==typeof e?e(null,u):void 0};var o=r.objectStore(n),i=o.get(t),u=null;i.onsuccess=function(n){u=n.target.result},i.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}},query:function(n,t,e,r){3===arguments.length&&(r=e,e=null),2===arguments.length&&(r=t,t=null,e=null);var o=[],i=this.db.transaction(n,"readonly");i.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},i.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},i.oncomplete=function(){return r&&"function"==typeof r?r(null,o):void 0};var u=i.objectStore(n),a=u;if(null!==t&&t.index&&(a=u.index(t.index)),null!==t&&t.limit)var c=t.limit;var s;s=null===t?a.openCursor():a.openCursor(t.range,t.direction),s.onsuccess=function(n){var t=n.target.result;if(t){if(e?e(t.value):o.push(t.value),c&&(c--,0===c))return;t.continue()}},s.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},put:function(n,t,e,r){var o={};4===arguments.length&&(o.key=Array.isArray(e)?e:[e]),3===arguments.length&&(r=e,e=null),o.value=Array.isArray(t)?t:[t];var i=[],u=this.db.transaction(n,"readwrite");u.onabort=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0},u.oncomplete=function(){return i=1===i.length?i[0]:i,r&&"function"==typeof r?r(null,i):void 0};for(var a=u.objectStore(n),c=function(n,t){var e=a.put(n,t);e.onsuccess=function(n){i.push(n.target.result)},e.onerror=function(n){return r&&"function"==typeof r?r(n.target.error):void 0}},s=0;s<o.value.length;s++)o.key?c(o.value[s],o.key[s]):c(o.value[s])},"delete":function(n,t,e){var r=this.db.transaction(n,"readwrite");r.onabort=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},r.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0},r.oncomplete=function(){return e&&"function"==typeof e?e(null):void 0};var o=r.objectStore(n),i=o.delete(t);i.onsuccess=function(){},i.onerror=function(n){return e&&"function"==typeof e?e(n.target.error):void 0}},clear:function(n,t){var e=this.db.transaction(n,"readwrite");e.onabort=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},e.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0},e.oncomplete=function(){return t&&"function"==typeof t?t(null):void 0};var r=e.objectStore(n),o=r.clear();o.onsuccess=function(){},o.onerror=function(n){return t&&"function"==typeof t?t(n.target.error):void 0}}}}(),function(){"use strict";var n=window.Batoh;n.sync=function(t,e,r){function o(n){var t={index:"timestamp",range:IDBKeyRange.upperBound(Number.POSITIVE_INFINITY,!0),direction:"prev",limit:1};g.openDB(function(){g.query(e,t,function(t,e){t&&n(t);var r=e[0]?e[0].timestamp:0;g.closeDB(),i(r)})})}function i(n){var t,e=new XMLHttpRequest;e.open("GET",m+"?last_sync="+n,!0),e.send(),e.onload=function(){t=this.response;var n=JSON.parse(t);u(n)},e.onerror=function(n){v(n)}}function u(n){var t=y(n.length,g,c);g.openDB(function(){return err?v(err):void n.forEach(function(n){g.get(e,n.id,function(r,o){var i=o;return r?v(r):void(i?i.dirty===!0?a(i,n,t):n.deleted===!0?g.delete(e,n.id,function(n){return n?v(n):void t()}):g.put(e,n,function(n){return n?v(n):void t()}):g.add(e,n,function(n){return n?v(n):void t()}))})})})}function a(n,t,e){e()}function c(){var n={index:"timestamp",range:null,direction:"next"},t=function(n){n.dirty===!0&&(""===n.timestamp?h.push(n):w.push(n))};g.openDB(function(){g.query(e,n,t,function(n){n&&v(n),g.closeDB(),s()})})}function s(){var n=y(h.length+w.length,null,p);if(h.length>0)for(var t=0;t<h.length;t++)f(h[t],n);if(w.length>0)for(var e=0;e<w.length;e++)d(w[e],n)}function f(n,t){var e,r=JSON.stringify(n),o=new XMLHttpRequest;o.open("POST",m,!0),o.setRequestHeader("Content-type","application/json; charset=utf-8"),o.send(r),o.onload=function(){return e=JSON.parse(this.response),e.timestamp?(n.timestamp=e.timestamp,void l(n,t)):v(new Error("No timestamp in POST response."))},o.onerror=function(n){v(n),t()}}function d(n,t){var e,r=JSON.stringify(n),o=new XMLHttpRequest;o.open("PUT",m+"/"+n.id,!0),o.setRequestHeader("Content-type","application/json; charset=utf-8"),o.send(r),o.onload=function(){return e=JSON.parse(this.response),e.timestamp?(n.timestamp=e.timestamp,void l(n,t)):v(new Error("No timestamp in PUT response."))},o.onerror=function(n){v(n),t()}}function l(n,t){g.openDB(function(){n.deleted?g.delete(e,n.id,function(){g.closeDB(),t()}):(n.dirty=!1,g.put(e,n,function(){g.closeDB(),t()}))})}function p(){console.log("sync complete")}function v(n,t){console.error(n.message),t&&t()}function y(n,t,e){if(0===n)return e();var r=n,o=function(){return r--,0===r?(t&&t.closeDB(),e()):void 0};return o}var g=new n.Pocket(t),m="/"+e||r.url;r.onComplete&&(p=r.onComplete),r.onError&&(v=r.onError),r.resolveConflict&&(a=r.resolveConflict);var h=[],w=[];o()}}();